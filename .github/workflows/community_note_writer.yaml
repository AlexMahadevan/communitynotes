name: Template API Note Writer

on:
  # Manual trigger via Actions ▸ Run workflow
  workflow_dispatch:

  # Uncomment to schedule automated runs  (every 15 min)
  #schedule:
  #  - cron: '*/15 * * * *'

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  regular_run:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      # ──────────────────────────────────────────────
      # 0)  Pin Python to 3.11 so uv.lock matches
      #     (If you regenerate uv.lock for 3.12 later,
      #      bump this to '3.12')
      # ──────────────────────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Install project dependencies
        run: cd template-api-note-writer && uv sync --locked

      - name: Install xurl CLI
        run: |
          sudo bash -c "$(curl -fsSL https://raw.githubusercontent.com/xdevplatform/xurl/main/install.sh)"

      - name: Authenticate xurl via OAuth 1.0
        run: xurl auth oauth1 \
              --consumer-key "$X_API_KEY" \
              --consumer-secret "$X_API_KEY_SECRET" \
              --access-token "$X_ACCESS_TOKEN" \
              --token-secret "$X_ACCESS_TOKEN_SECRET"
        env:
          X_API_KEY:              ${{ secrets.X_API_KEY }}
          X_API_KEY_SECRET:       ${{ secrets.X_API_KEY_SECRET }}
          X_ACCESS_TOKEN:         ${{ secrets.X_ACCESS_TOKEN }}
          X_ACCESS_TOKEN_SECRET:  ${{ secrets.X_ACCESS_TOKEN_SECRET }}

      - name: Run bot (test‑mode)
        run: cd template-api-note-writer && uv run src/main.py
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          # TEST_MODE defaults to 1 inside main.py; set TEST_MODE=0 after admission
